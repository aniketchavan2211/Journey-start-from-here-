from cryptography.fernet import Fernet, InvalidToken
import sqlite3
import os


# database name and key path 
db = 'database.db'
path = "key.key"

class PasswordDecryptionError(Exception):
    pass

def key():
    # Check if the key file exists
    if not os.path.isfile(path):

        # Generate a Fernet key
        fernet_key = Fernet.generate_key()
        '''
        # Save the key to a file
        with open(path, 'wb') as fernet_key:
            fernet_key.write(key)
        '''        
        # Store the key in the 'secret' table
        store_key_in_database(fernet_key)

    else:
        '''
        # Read the key from a file (assuming the key is stored in a file)
        with open(path, 'rb') as fernet_key:
            fernet_key = fernet_key.read()
        '''
        # Retrieve the key from the 'secret' table
        fernet_key = get_key_from_database()
        if fernet_key:
            print("Successfully retrieved the Fernet key.")
        else:
            print("Fernet key not found in the database.")
    return fernet_key

def generate_new_key():
    new_key = Fernet.generate_key()
    '''
    with open(path, "wb") as fernet_key:
            fernet_key.write(new_key)
    print("New Fernet key generated and saved as 'key.key'.")
    '''
    fernet_key = store_key_in_database(new_key)
    return fernet_key

def create_database():
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    # Create the 'users' table with columns 'username', 'password_hash', and 'salt'
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            username TEXT PRIMARY KEY,
            password_hash TEXT,
            salt BLOB
        )
    ''')

    # Create a table to store encrypted passwords
    cursor.execute(
        '''CREATE TABLE IF NOT EXISTS passwords (id INTEGER PRIMARY KEY, website TEXT, encrypted_password TEXT)''')


    # Create the 'secret' table if it doesn't exist
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS secret (
            key_name TEXT PRIMARY KEY,
            key_value TEXT
        )
    ''')

    conn.commit()
    conn.close()

def check_duplicate_username(username):
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    cursor.execute("SELECT username FROM users WHERE username=?", (username,))
    existing_user = cursor.fetchone()

    conn.close()

    return existing_user is not None

def store_user_in_database(username, hashed_password, salt, fernet_key):
    conn = sqlite3.connect(db)
    cursor = conn.cursor()
    
    # Assuming you have a table named 'users' with columns 'username', 'password_hash', and 'salt'
    cursor.execute("INSERT INTO users (username, password_hash, salt) VALUES (?, ?, ?)", (username, hashed_password, salt))
   
    conn.commit()
    conn.close()

def store_key_in_database(fernet_key):
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    # Insert or update the Fernet key in the 'secret' table
    cursor.execute("INSERT OR REPLACE INTO secret (key_name, key_value) VALUES (?, ?)", ("fernet_key", fernet_key.decode()))

    conn.commit()
    conn.close()

def get_key_from_database():
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    # Query the 'secret' table to retrieve the Fernet key
    cursor.execute("SELECT key_value FROM secret WHERE key_name = ?", ("fernet_key",))
    result = cursor.fetchone()

    conn.close()

    if result:
        key_value = result[0]
        return Fernet(key_value.encode())
    else:
        return None

def retrieve_user_info(username):
    conn = sqlite3.connect(db)
    cursor = conn.cursor()
    
    # Assuming you have a table named 'users' with columns 'username', 'password_hash', and 'salt'
    cursor.execute("SELECT password_hash, salt FROM users WHERE username = ?", (username,))
    result = cursor.fetchone()

    conn.close()

    if result:
        password_hash, salt = result
        return password_hash, salt
    else:
        return None, None

def store_password(website, password, fernet_key):
    encrypted_password = encrypt_password(password, fernet_key)
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    cursor.execute("INSERT INTO passwords (website, encrypted_password) VALUES (?, ?)",
                   (website, encrypted_password))
    conn.commit()
    conn.close()
    
def retrieve_password(website, fernet_key):
    conn = sqlite3.connect(db)
    cursor = conn.cursor()

    cursor.execute(
        "SELECT encrypted_password FROM passwords WHERE website=?", (website,))
    result = cursor.fetchone()
    
    if not result:
        return None

    try:
        password = decrypt_password(result[0], fernet_key)
        return password
    except InvalidToken:
        raise PasswordDecryptionError("Failed to decrypt the password. Keys may not match.")

    conn.close()

    return None

def encrypt_password(password, fernet_key):
    password = password
    fernet = Fernet(fernet_key)
    return fernet.encrypt(password.encode())

def decrypt_password(encrypted_password, fernet_key):
    fernet = Fernet(fernet_key)
    return fernet.decrypt(encrypted_password).decode()
